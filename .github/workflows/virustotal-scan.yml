name: VirusTotal Scan

on:
  # Auto-trigger after Build Release completes successfully
  workflow_run:
    workflows: ["Build Release"]
    types: [completed]
  # Manual trigger as fallback
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to scan (e.g. v2.6.258)'
        required: true

permissions:
  contents: write  # Required for updating release body

jobs:
  virustotal:
    runs-on: ubuntu-latest
    # Only run if Build Release succeeded (skip on failure/cancellation)
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Get release tag
        id: get-tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            # Extract tag from the Build Release run (triggered by tag push)
            TAG="${{ github.event.workflow_run.head_branch }}"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          fi

      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ steps.get-tag.outputs.tag }}
          fileName: '*'
          out-file-path: assets

      - name: VirusTotal Scan
        id: vt-scan
        uses: crazy-max/ghaction-virustotal@v4
        with:
          vt_api_key: ${{ secrets.VT_API_KEY }}
          update_release_body: false
          github_token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            assets/MedicalAssistant-Linux.tar.gz
            assets/MedicalAssistant-Windows.zip
            assets/MedicalAssistant-macOS.dmg

      - name: Update release body with VirusTotal results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.get-tag.outputs.tag }}
          VT_ANALYSIS: ${{ steps.vt-scan.outputs.analysis }}
        run: |
          # Get the current release body
          CURRENT_BODY=$(gh release view "$TAG" --json body -q '.body' 2>/dev/null || echo "")

          # Strip any previous VirusTotal section
          CLEAN_BODY=$(echo "$CURRENT_BODY" | sed '/^## VirusTotal Analysis/,$d' | sed -e :a -e '/^\n*$/{$d;N;ba}')

          # Build the VirusTotal results section from the analysis output
          # Format: file=url,file=url,...
          VT_SECTION="## VirusTotal Analysis"
          VT_SECTION="$VT_SECTION"$'\n\n'"| File | VirusTotal Results |"
          VT_SECTION="$VT_SECTION"$'\n'"| --- | --- |"

          IFS=',' read -ra ENTRIES <<< "$VT_ANALYSIS"
          for entry in "${ENTRIES[@]}"; do
            # Format is "path=https://..." â€” split on first = only
            FILE="${entry%%=*}"
            URL="${entry#*=}"
            FILE=$(basename "$FILE" 2>/dev/null || echo "$FILE")
            if [ -n "$URL" ] && [ -n "$FILE" ]; then
              VT_SECTION="$VT_SECTION"$'\n'"| $FILE | [View Results]($URL) |"
            fi
          done

          # Combine and update
          if [ -n "$CLEAN_BODY" ]; then
            NEW_BODY="$CLEAN_BODY"$'\n\n'"$VT_SECTION"
          else
            NEW_BODY="$VT_SECTION"
          fi

          gh release edit "$TAG" --notes "$NEW_BODY"
          echo "Release $TAG updated with VirusTotal results"
